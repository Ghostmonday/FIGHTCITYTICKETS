# Database Migrations with Alembic

This directory contains Alembic migration scripts for managing database schema changes.

## Quick Start

### Initial Setup (First Time)

1. **Create initial migration** (if tables already exist, this creates a baseline):
   ```bash
   alembic revision --autogenerate -m "Initial schema"
   ```

2. **Review the generated migration** in `alembic/versions/` before applying

3. **Apply migrations**:
   ```bash
   alembic upgrade head
   ```

### Common Commands

- **Create a new migration**:
  ```bash
  alembic revision --autogenerate -m "Description of changes"
  ```

- **Apply all pending migrations**:
  ```bash
  alembic upgrade head
  ```

- **Apply next migration only**:
  ```bash
  alembic upgrade +1
  ```

- **Rollback one migration**:
  ```bash
  alembic downgrade -1
  ```

- **Rollback to specific revision**:
  ```bash
  alembic downgrade <revision_id>
  ```

- **Show current revision**:
  ```bash
  alembic current
  ```

- **Show migration history**:
  ```bash
  alembic history
  ```

- **Show pending migrations**:
  ```bash
  alembic heads
  ```

## Migration Workflow

1. **Make model changes** in `src/models/__init__.py`
2. **Generate migration**: `alembic revision --autogenerate -m "Description"`
3. **Review the migration file** - Alembic is good but not perfect
4. **Test migration**: `alembic upgrade head` (on test database first!)
5. **Commit migration file** to version control
6. **Deploy**: Run `alembic upgrade head` as part of deployment

## Important Notes

- **Always review autogenerated migrations** before applying
- **Test migrations on a copy of production data** before deploying
- **Never edit existing migration files** that have been applied to production
- **Create new migrations** for any changes to already-applied migrations
- **Backup database** before running migrations in production

## Environment Variables

Migrations use the `DATABASE_URL` from your `.env` file or environment variables.

Make sure your `.env` file is configured:
```env
DATABASE_URL=postgresql+psycopg://user:password@host:port/database
```

## Troubleshooting

### Migration conflicts
If you have conflicts between branches:
1. Identify the conflicting revisions
2. Create a merge migration: `alembic merge -m "Merge branch1 and branch2" heads`

### Manual migration edits
Sometimes you need to manually edit a migration:
- Add data migrations
- Fix autogenerate issues
- Add custom SQL

Always test thoroughly after manual edits!

